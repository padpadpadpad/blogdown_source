---
title: "Introducing nlsLoop"
author: "Daniel Padfield"
date: 2016-09-08T21:13:14-05:00
slug: introducing-nlsloop
categories: ["R"]
tags: ["nlsLoop", "non-linear regression"]
draft: false
---

## Introduction

So you have data you want to fit to a non-linear model...

This blog post assumes you have a non-linear model formulation you want to fit to non-linear data and are aware of the excellent `nlme` package by Pinheiro and Bates and their [book](Mixed-Effects Models in S and S-PLUS (Statistics and Computing)) that nicely explains how to use it. This would be my first port of call if you want to understand the simplicities and complexities of fitting non-linear models and mixed effect models in general.

This blog post is less about when to use non-linear regression or non-linear mixed effects models but more about a method of ensuring the __best fit each curve__ to its data.

When fitting non-linear models to data, it is common to want to fit the same model to multiple levels of a factor. In this situation `nlme::nlsList()` is often used to loop through levels of factor such as `nlsList(Y ~ function(X)|factor)`. However, `nlsList()` only allows a single set of starting parameters. 

If you have a dataset where every level of the factor fits the same model, but spans several magnitudes of parameter values, you will be familiar with the error: 

`Error in nlsList(Y ~ function(X)|factor): singular gradient`

that is often caused by starting parameters being too far away from the actual values in parameter space. This often means `nlsList()` is inadequate for fitting multiple non-linear models.

`nlsLoop` is a package hosted on [GitHub](https://github.com/padpadpadpad/TeamPhytoplankton) that allows multiple starting values to be used to ensure the best fit to each separate curve.
`nlsLoop::nlsLoop()` fits the same model over a level of a factor and allows multiple starting values and picks the best model using AIC score.

#### Key parameters of nlsLoop()
- model: the non-linear model specification
- data: the raw data frame
- tries: the number of combinations of starting values you want the model to try
- id_col: the column that has a unique identifier for each specific curve you want to model
- param\_bds: a vector specifying the boundaries of your starting parameter estimates. It is important to __LOOK__ at your data and previous literature at this point to try and work what reasonable ranges of parameters are! 
    - These are specified as c(lower bound parameter 1, upper bound parameter 1, lower bound parameter 2, upper bound parameter 2, lower bound parameter _n_, upper bound parameter _n_).
- _r<sup>2</sup>_ : whether or not you want to calculate an _r<sup>2</sup>_ value for each of your fits. This parameter comes with a [warning](http://stackoverflow.com/questions/14530770/calculating-r2-for-a-nonlinear-model) that _r<sup>2</sup>_ do not mean the same things for non-linear models as they do for linear models<sup>[1]</sup>.

## Using nlsLoop

#### 1. Load in packages and install nlsLoop

```{r load in packages, message=FALSE, warning=FALSE}
devtools::install_github('padpadpadpad/nlsLoop')

library(nlsLoop)
library(dplyr)
library(magrittr)
library(tidyr)
library(ggplot2)

```

#### 2. Load in data frame and initial plot

The data we shall use for this tutorial are a bunch of thermal performance curves showing the relationship between metabolic rates and temperature in the aquatic alga, _Chlorella vulgaris_<sup>[2]</sup>.

So enough talking, lets load in the data and have an initial look at the data.

```{r load in data and look, tidy=TRUE}
data('Chlorella_TRC')

head(Chlorella_TRC)
```

As you can see, and read about in the [paper](http://onlinelibrary.wiley.com/doi/10.1111/ele.12545/full) (__YES, THIS IS A PLUG__), we have rates of metabolism for both photosynthesis and respiration across 5 different growth temperatures after both 10 (acclimation) and 100 (adaptation) generations of growth, so we can have a go at an initial plot accordingly...

```{r first plot, fig.width=12, fig.height=9}
ggplot(Chlorella_TRC) +
  geom_point(aes(temp, ln.rate, col = growth.temp), shape = 21, size = 2, alpha = 0.5) +
  facet_wrap(~flux + process, labeller = labeller(.multi_line = F)) +
  scale_colour_gradient(low = 'blue', high = 'red', 'Growth Temperature') +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  ylab('log Metabolic rate') +
  xlab('Assay temperature (ºC)')
```

The data follows a classic unimodal thermal performance curve and can be modelled using a modified version of the Sharpe-Schoolfield model<sup>[3]</sup>. A function characterising the model is provided in the package as `schoolfield.high()`. This is more about the fitting of non-linear curves than the model so that's as in depth as I will go here!

The data has 60 separate curves and `id_col = curve_id`. So lets fit the model!

#### 3. Run nlsLoop

`nlsLoop::nlsLoop()` uses `minpack.lm::nlsLM()` to fit each individual curve allows addiitional arguments such as `lower` and `na.action` accordingly. The best fit for each factor level is determined using AIC scores and if the best fit does not change for 100 "tries" then it will move onto the next level of the factor.

```{r nlsLoop, message=FALSE, warning=FALSE, results='hide'}
fits <- nlsLoop(ln.rate ~ schoolfield.high(ln.c, Ea, Eh, Th, temp = K, Tc = 20),
                     data = Chlorella_TRC,
                     tries = 500,
                     id_col = 'curve_id',
                     param_bds = c(-10, 10, 0.1, 2, 0.5, 5, 285, 330),
                     r2 = 'Y',
                     supp.errors = 'Y',
                     AICc = 'Y',
                     na.action = na.omit,
                     lower = c(ln.c=-10, Ea=0, Eh=0, Th=0))

```

__WARNING: This may take quite a while depending on how good your parameter boundaries are!__

The result of this returns an `nlsLoop` object that is made up of `params` which has all of our parameter values for each individual fit and `predictions` which is a high resolution predicted dataframe to allow for a smooth curve on a plot (which we will come to later).

These can be accessed simply using `fits$params` or `fits$predictions`.

```{r}
head(fits$params)
```

Having all of these in a single `nlsLoop` object allows a simple plotting method to assess how good our fits to the data are.  One of the best ways to assess non-linear model is by __ACTUALLY LOOKING__ at how well every model fits its respective raw data.

#### 4. Plotting

Firstly lets have a look at a single level of `curve_id`, a function called `plot_id_nlsLoop()` allows this.

```{r first fit plot, fig.height=6, fig.width=8}
plot_id_nlsLoop(raw_data = Chlorella_TRC, param_data = fits, id = '1')
```

Not a bad fit... Further to this, `plot_all_nlsLoop()` will produce a pdf with each plot on a new sheet.

```{r pdf fits, eval=FALSE}
plot_all_nlsLoop('path/of/where/you/want/to/save/me.pdf', raw_data = Chlorella_TRC, param_data = fits)
```

#### 5. Exploratory analysis

We can now edit some of the dataframes to look at the curves split by the treatments within the dataset and explore how the parameter values change across the treatments.

For example we can plot all the curves split by respiration, photosynthesis and acclimatory or adaptive timescales.

```{r data wrangling, fig.width=12, fig.height=9}

# select treatment columns from original dataset
treatments <- select(Chlorella_TRC, c(curve_id, process, growth.temp, flux))
# keep unique combinations of treatments
treatments <- unique(treatments[,colnames(treatments)])

# bind treatments to predictions and parameter dataframe
fits$params <- merge(fits$params, treatments, by = 'curve_id')
fits$predictions <- merge(fits$predictions, treatments, by = 'curve_id')

# plot every curve
ggplot() +
  geom_point(aes(K, ln.rate, col = growth.temp), shape = 21, size = 2, alpha = 0.25, Chlorella_TRC) +
  geom_line(aes(K, ln.rate, col = growth.temp, group = curve_id), linetype = 2, alpha = 0.5, fits$predictions) +
  facet_wrap(~flux + process, labeller = labeller(.multi_line = F)) +
  scale_colour_gradient(low = 'blue', high = 'red', 'Growth Temperature') +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  ylab('log Metabolic rate') +
  xlab('Assay temperature (ºC)')

```

We can also start having a quick look at any differences between parameters...

```{r parameter plots, fig.height=8, fig.width=10}

gather(fits$params, 'parameter', 'value', c(ln.c, Ea, Eh, Th)) %>%
  ggplot(.) +
  geom_point(aes(growth.temp, value, col = flux, shape = process), fill = 'white', size = 2, position = position_dodge(width = 0.25)) +
  facet_wrap(~ parameter, scales = 'free_y') +
  scale_color_manual(values = c('green4', 'black')) +
  scale_shape_manual(values = c(21, 24)) +
  theme_bw(base_size = 16, base_family = 'Helvetica')
  

```

From here we can see that the activation energy (_E~a~_) in the model does not change systematically with growth temperature or whether it has acclimated or adapted to the growth temperature. However a body of work has shown that photosynthesis should be less sensitive to temperature change (a lower _E~a~_) than that of respiration.

```{r Ea plots, fig.height=6, fig.width=8}
ggplot(fits$params, aes(flux, Ea)) +
  geom_boxplot(aes(fill = flux, col = flux), outlier.shape = NA, width = 0.5) +
  stat_summary(geom = 'crossbar', fatten = 0, color = 'white', width = 0.5, fun.data = function(x){ return(c(y=median(x), ymin=median(x), ymax=median(x)))}) +
  geom_jitter(aes(flux, Ea, col = flux), shape = 21, fill ='white', width = 0.25, height = 0) +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  scale_color_manual(values = c('green4', 'black')) +
  scale_fill_manual(values = c('green4', 'black')) +
  ylab('Activation enrrgy (eV)') +
  xlab('Flux')
  

```

And as we can see it looks like we have a difference in the activation energies, with photosynthesis having a lower activation energy than respiration.

So from there we can start exploring our data and formally analysing our parameters! `nlsLoop` allows us to have confidence in our fitting of all the curves and gives us an easy way of plotting and manipulating the data afterwards! 

Happy model fitting. Any comments much appreciated.

### References:
[1] Spiess, A.N. & Neumeyer, N. (2010). An evaluation of R<sup>2</sup> as an inadequate measure for nonlinear models in pharmacological and biochemical research: a Monte Carlo approach. BMC Pharmacology, 10, 6.

[2] Padfield, D., Yvon-durocher, G., Buckling, A., Jennings, S. & Yvon-durocher, G. (2015). Rapid evolution of metabolic traits explains thermal adaptation in phytoplankton. Ecology Letters, 19(2), 133-142.

[3] Schoolfield, R.M., Sharpe, P.J. & Magnuson, C.E. (1981). Non-linear regression of biological temperature-dependent rate models based on absolute reaction-rate theory. J. Theoretical Biology, 88, 719–31.

